---
- name: Install packages
  community.general.zypper:
    name: "{{ uyuni_pkgs }}"
  notify: Reboot system (if immutable)
  become: true

- name: Stage deploy configuration
  ansible.builtin.template:
    src: uyuni.yml.j2
    dest: "/root/uyuni.yml"
    mode: "0644"
    owner: root
    group: root
  become: true

- name: Download airgapped container image
  community.general.zypper:
    name: suse-manager-{{ uyuni_suma_release }}-{{ ansible_architecture }}-server-image
  notify: Reboot system (if immutable)
  when: uyuni_suma_airgapped
  become: true

- name: Trigger reboot (if necessary)
  ansible.builtin.meta: flush_handlers

- name: Run installation
  ansible.builtin.command: "mgradm -c /root/uyuni.yml install podman {{ ansible_fqdn }}"
  args:
    creates: /root/.MANAGER_INITIALIZATION_COMPLETE
  become: true
  notify: Create initialization file
