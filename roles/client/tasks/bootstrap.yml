---
- name: Check if Uyuni server was set
  ansible.builtin.fail:
    msg: Set client_uyuni_server to a valid server hostname/FQDN
  when: client_uyuni_server is undefined

- name: Check if the client_repo_file exists
  ansible.builtin.stat:
    path: "{{ client_repo_file }}"
  register: client_stat_repo_file

- name: Download Uyuni bootstrap script
  when: not client_stat_repo_file.stat.exists
  ansible.builtin.get_url:
    url: "http://{{ client_uyuni_server }}/pub/bootstrap/{{ client_bootstrap_filename }}"
    dest: "{{ client_bootstrap_folder }}/bootstrap.sh"
    owner: root
    group: root
    mode: '0755'
    force: true
  become: true

- name: Register with Uyuni
  ansible.builtin.command: "{{ client_bootstrap_folder }}/bootstrap.sh"
  args:
    creates: "{{ client_repo_file }}"
  become: true

- name: Remove downloaded bootstrap script
  ansible.builtin.file:
    path: "{{ client_bootstrap_folder }}/bootstrap.sh"
    state: absent
  become: true
